name: Run Unit Tests, SonarCloud Analysis, and ZAP Scan

on:
  push:
  pull_request:

jobs:
  test-and-security:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout code
      - name: Checkout code
        uses: actions/checkout@v3

      # 2️⃣ Set up Python
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      # 3️⃣ Install dependencies
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install httpx pytest pytest-cov

      # 4️⃣ Run tests with coverage (HTML + XML)
      - name: Run tests and generate coverage
        run: |
          export PYTHONPATH=$PYTHONPATH:$(pwd)
          pytest --maxfail=1 --disable-warnings --cov=src \
                 --cov-report=term-missing \
                 --cov-report=html \
                 --cov-report=xml:coverage.xml

      # 5️⃣ Upload HTML coverage report
      - name: Upload coverage HTML report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: htmlcov

      # 6️⃣ Run SonarCloud / SonarQube scan
      - name: SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@fd88b7d7ccbaefd23d8f36f73b59db7a3d246602
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_SCANNER_OPTS: "-Dsonar.python.coverage.reportPaths=coverage.xml"

     
     # 8️⃣ ZAP Full Scan on localhost
      - name: ZAP Full Scan
        uses: zaproxy/action-full-scan@v0.13.0
        with:
          token: ${{ github.token }}
          target: http://127.0.0.1:8000
          docker_name: ghcr.io/zaproxy/zaproxy:stable
          issue_title: "ZAP Full Scan Report"
          fail_action: true
          allow_issue_writing: true
          artifact_name: zap_scan
