name: Tests, SonarCloud, and ZAP Scan

on:
  push:
  pull_request:

jobs:
  ci-security:
    runs-on: ubuntu-latest

    steps:
      ##############################################
      # 1Ô∏è‚É£ CHECKOUT
      ##############################################
      - name: Checkout code
        uses: actions/checkout@v3

      ##############################################
      # 2Ô∏è‚É£ PYTHON SETUP
      ##############################################
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      ##############################################
      # 3Ô∏è‚É£ INSTALL DEPENDENCIES
      ##############################################
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest httpx pytest-cov uvicorn

      ##############################################
      # 4Ô∏è‚É£ UNIT TESTS + COVERAGE (HTML+XML)
      ##############################################
      - name: Run tests and generate coverage
        run: |
          export PYTHONPATH=$PYTHONPATH:$(pwd)
          pytest --maxfail=1 --disable-warnings --cov=src \
                 --cov-report=term-missing \
                 --cov-report=html \
                 --cov-report=xml:coverage.xml

      ##############################################
      # 5Ô∏è‚É£ UPLOAD COVERAGE ARTIFACT
      ##############################################
      - name: Upload coverage HTML report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: htmlcov

      ##############################################
      # 6Ô∏è‚É£ SONARCLOUD ANALYSIS
      ##############################################
      - name: SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@fd88b7d7ccbaefd23d8f36f73b59db7a3d246602
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_SCANNER_OPTS: "-Dsonar.python.coverage.reportPaths=coverage.xml"

      ##############################################
      # 7Ô∏è‚É£ BUILD FASTAPI DOCKER IMAGE
      ##############################################
      - name: Build FastAPI Docker image
        run: docker build -t myfastapiapp .

      ##############################################
      # 8Ô∏è‚É£ CREATE SHARED DOCKER NETWORK
      ##############################################
      - name: Create Docker network
        run: docker network create zapnet || true

      ##############################################
      # 9Ô∏è‚É£ RUN FASTAPI IN DOCKER (ACCESSIBLE TO ZAP)
      ##############################################
      - name: Run FastAPI container
        run: |
          docker run -d \
            --name fastapi \
            --network zapnet \
            -p 8000:8000 \
            myfastapiapp
          echo "Waiting for FastAPI to start..."
          sleep 15

      ##############################################
      # üîü ZAP FULL SCAN AGAINST YOUR API
      ##############################################
      - name: ZAP Full Scan
        uses: zaproxy/action-full-scan@v0.13.0
        env:
          DOCKER_NETWORK: zapnet
        with:
          token: ${{ github.token }}
          target: http://fastapi:8000
          docker_name: ghcr.io/zaproxy/zaproxy:stable
          fail_action: true
          allow_issue_writing: true
          issue_title: "ZAP Full Scan Report"
          artifact_name: zap_scan
